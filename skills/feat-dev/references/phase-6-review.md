# 阶段 6: 质量审查 (Quality Review)

## 目标

通过并行代码审查确保代码质量,识别 bug、安全漏洞、代码质量问题和规范违反。

---

## 并行 Code-Reviewer Agents

启动 **3 个 code-reviewer agents** 并行审查不同方面:

### Reviewer 示例(根据审查焦点调整)

```
Task:
- subagent_type: spec-dev:code-reviewer
- model: haiku
- prompt: "审查焦点: [Bug和逻辑错误/代码风格和质量/项目规范遵循]

  审查范围: [列出本次实施的所有文件路径]

  审查要点: [根据焦点列出具体检查项]

  请识别所有问题,按严重程度和置信度排序。"
- run_in_background: true
```

**建议分工**:
- Reviewer 1: Bug 和逻辑错误(空指针、资源泄漏、并发问题、逻辑错误)
- Reviewer 2: 代码风格和质量(命名规范、代码重复、函数复杂度、性能问题)
- Reviewer 3: 项目规范遵循(文件组织、命名约定、API 设计、错误处理)

---

## MCP 工具使用

### 🔍 优先尝试:exa.web_search_exa

**目的**:搜索已知安全漏洞和常见 bug 模式
**降级方案**:WebSearch

---

## 汇总审查结果并询问用户决策

**重要**:不要自动修复,而是**询问用户**如何处理

### 向用户展示

```markdown
## 🔍 质量审查完成

### 审查统计
- 发现问题总数: Y 个
  - 🔴 高严重性: A 个
  - 🟡 中严重性: B 个
  - 🟢 低严重性: C 个

### 高优先级问题

#### 🔴 高置信度 Bug(≥80%) - 建议立即修复
1. **空指针检查缺失** (置信度: 95%)
   - 文件: services/service.go:45
   - 影响: 可能导致崩溃
   - 修复预估: 5 分钟

### 中等问题
[列出中等严重性问题...]

---

## ❓ 你希望如何处理?

**选项 A: 立即修复所有高严重性问题**(推荐)
**选项 B: 仅修复高置信度 bug**
**选项 C: 暂不修复,记录问题**
**选项 D: 自定义**
```

---

## 处理审查结果

### 修复策略(基于用户决策)

#### 必须修复
1. 高置信度 bug(≥80%)
2. 严重规范违反

#### 应该修复
3. 中置信度 bug(60-79%)
4. 严重质量问题

#### 可选修复
5. 一般质量问题
6. 一般规范违反
7. 低置信度 bug(<60%)

### 修复记录

```markdown
### 修复记录

#### 已修复
1. ✅ **空指针检查缺失** (services/service.go:45)
   - 添加了 nil 检查和错误处理

#### 暂不处理
1. ⏸️ **函数过长**
   - 原因: 逻辑相对清晰,暂时可接受
   - 建议: 后续重构时优化
```

---

## 安全检查清单

### ✅ 输入验证
- [ ] 所有用户输入都经过验证
- [ ] 验证文件上传类型和大小

### ✅ 认证和授权
- [ ] 需要认证的端点添加了认证中间件
- [ ] 用户只能访问自己的资源

### ✅ 注入防护
- [ ] 使用 ORM 参数化查询
- [ ] 不拼接 SQL

### ✅ 敏感信息
- [ ] 不在日志中记录密码、token
- [ ] 不在响应中返回敏感字段

### ✅ 错误处理
- [ ] 不暴露内部实现细节
- [ ] 统一的错误响应格式

---

## 进入下一阶段

质量审查和修复完成后,进入 **阶段 7: 总结**。
