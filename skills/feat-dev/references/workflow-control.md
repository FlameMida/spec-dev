# 工作流控制

⚠️ **CRITICAL - 工作流执行规则**：
- **必须严格按照 1→2→3→4→5→6→7 的顺序执行**
- **每个阶段必须完整执行，禁止跳过**
- **在强制检查点必须停止并等待用户输入**
- **收到用户输入后必须继续当前阶段，不得跳出工作流**

## 阶段声明要求

**⚠️ 每个阶段开始时 MUST 输出（强制）**：
```markdown
---
## 🚀 当前阶段：[X] - [阶段名称]

⚠️ WORKFLOW CHECKPOINT: 当前处于阶段 [X]，必须完成本阶段所有任务后才能进入阶段 [X+1]
---
```

**⚠️ 每个阶段结束时 MUST 输出（强制）**：
```markdown
---
✅ 阶段 [X] 完成

📋 本阶段产出：
- [列出主要产出]

📍 下一阶段：[X+1] - [阶段名称]

⚠️ WORKFLOW CHECKPOINT: 准备进入阶段 [X+1]
---
```

## 用户输入后的继续机制

⚠️ **CRITICAL - 收到用户输入后的处理规则**：

当用户在阶段中提供输入（如回答澄清问题、确认架构方案）后，**MUST 执行以下步骤**：

1. **MUST 确认收到输入**：
```markdown
---
📥 已收到用户输入

⚠️ WORKFLOW CHECKPOINT: 继续阶段 [X] - [阶段名称]
（禁止跳出当前 skill，禁止跳过任何阶段）
---
```

2. **MUST 处理用户输入**：整合到当前阶段的分析中

3. **MUST 继续当前阶段**：完成阶段剩余工作

4. **MUST 完成阶段后才能进入下一阶段**：输出阶段完成标记

5. **CRITICAL - 绝对禁止**：
   - ❌❌❌ 跳出当前 skill（除非用户明确要求）
   - ❌❌❌ 重新评估 skill 触发条件
   - ❌❌❌ 跳过任何阶段（如从阶段 1 直接到阶段 5）
   - ❌❌❌ 在未完成当前阶段时进入下一阶段
   - ❌❌❌ 在收到用户输入后直接开始实施（必须先完成阶段 3 和阶段 4）

## 强制检查点（MANDATORY CHECKPOINTS）

以下检查点是**强制性的**，必须停止并等待用户输入：

### 阶段 1 → 2

- 完成需求理解后，**MUST 输出阶段完成标记**
- 然后进入阶段 2（代码库探索）
- ❌ 禁止在阶段 1 收到用户输入后直接跳到阶段 2 之后的任何阶段

### 阶段 3 → 4（如有澄清问题）

- 如果使用了 AskUserQuestion，**MUST 停止并等待用户回应**
- **MUST 收到回应后输出确认标记**（见上方"用户输入后的继续机制"）
- **MUST 继续阶段 3 完成澄清**
- **MUST 输出阶段 3 完成标记**
- 然后才能进入阶段 4
- ❌❌❌ **CRITICAL**：禁止收到用户回应后直接跳到阶段 5（实施）

### 阶段 4 → 5（CRITICAL CHECKPOINT）

- **⚠️⚠️⚠️ 这是最关键的检查点**
- **MUST 等待用户明确确认架构方案**（必须看到用户回复"确认"、"可以"、"开始实施"等明确同意的词）
- 用户确认前**ABSOLUTELY PROHIBITED 开始实施**（绝对禁止）
- 如果用户要求修改，**MUST 更新设计并重新请求确认**
- **MUST 收到确认后输出确认标记和阶段完成标记**
- ❌❌❌ **CRITICAL**：禁止在用户未确认的情况下开始任何实施工作
- ❌❌❌ **CRITICAL**：禁止假设用户默认同意
- ❌❌❌ **CRITICAL**：禁止在展示架构设计后直接开始实施

### 阶段 5 → 6

- 实施必须完成
- **MUST 输出阶段完成标记**
- 然后进入阶段 6（质量审查）
- ❌ 禁止在实施中途跳到审查

## 阶段顺序规则

⚠️ **CRITICAL - 严格的阶段执行顺序**：

**必须按此顺序执行**：1 → 2 → 3 → 4 → 5 → 6 → 7

**每个阶段的执行要求**：
1. **阶段 1（需求理解）**：MUST 完成需求分析
2. **阶段 2（代码库探索）**：MUST 完成代码探索和文件阅读
3. **阶段 3（澄清问题）**：MUST 完成问题澄清（如有疑问必须提问）
4. **阶段 4（架构设计）**：MUST 完成设计并**等待用户确认**
5. **阶段 5（实施）**：仅在用户确认后 MUST 完成实施
6. **阶段 6（质量审查）**：MUST 完成代码审查
7. **阶段 7（总结）**：MUST 完成总结

**允许回退（向前回退）**：
- ✅ 阶段 5 发现需求理解有误 → 回退到阶段 3 或 4
- ✅ 阶段 4 用户要求修改设计 → 停留在阶段 4 更新设计
- ✅ 任何阶段发现问题 → 可以回退到之前的阶段重新分析

**❌❌❌ ABSOLUTELY PROHIBITED（绝对禁止的跳跃）**：
- ❌❌❌ 从阶段 1 直接到阶段 5（跳过探索、澄清、设计）
- ❌❌❌ 从阶段 2 直接到阶段 5（跳过澄清和设计）
- ❌❌❌ 从阶段 3 直接到阶段 5（跳过架构设计）
- ❌❌❌ 从阶段 4 直接到阶段 5 而未等待用户确认
- ❌❌❌ 在用户提供输入后跳过多个阶段
- ❌❌❌ 在任何阶段未完成时进入下一阶段

**⚠️ 违反阶段顺序的常见错误模式**：
```
错误模式 1: 阶段 1 → 直接开始代码探索并实施
正确做法: 阶段 1 → 阶段 2 → 阶段 3 → 阶段 4 → [等待确认] → 阶段 5

错误模式 2: 阶段 1 → 用户回复 → 直接实施
正确做法: 阶段 1 → 阶段 2 → 阶段 3 → 阶段 4 → [等待确认] → 阶段 5

错误模式 3: 阶段 4 设计完成 → 直接实施
正确做法: 阶段 4 设计完成 → 请求用户确认 → [停止等待] → 收到确认 → 阶段 5

错误模式 4: 收到用户输入 → 跳出 skill
正确做法: 收到用户输入 → 确认收到 → 继续当前阶段 → 完成后进入下一阶段
```
