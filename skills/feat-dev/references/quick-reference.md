# 快速参考

本文档提供 7 阶段工作流的快速检查清单和常用信息。

---

## ⚠️ 工作流控制要点

### 阶段标记（必须）

**每个阶段开始**：
```markdown
---
## 🚀 当前阶段：[X] - [阶段名称]
---
```

**每个阶段结束**：
```markdown
---
✅ 阶段 [X] 完成
📍 下一阶段：[X+1] - [阶段名称]
---
```

**用户输入后继续**：
```markdown
---
📥 已收到用户输入
🔄 继续阶段 [X] - [阶段名称]
---
```

### 强制检查点

- **阶段 3 → 4**：使用 AskUserQuestion 后必须等待用户回应
- **阶段 4 → 5**：**必须**等待用户确认架构方案
- **阶段 5 → 6**：实施完成才能审查

### 禁止跳跃

- ❌ 不能从阶段 3 直接到阶段 5
- ❌ 不能在未确认架构时开始实施
- ❌ 收到用户输入后不能跳出 skill

---

## 7 阶段检查清单

### ✅ 阶段 1: 需求理解
- [ ] 识别核心功能
- [ ] 识别业务实体
- [ ] 识别 API 端点（初步）
- [ ] 识别业务规则
- [ ] 识别集成点
- [ ] 复杂需求使用 ultrathink 深度分析
- [ ] 可选：搜索类似实现案例（exa/WebSearch）

**产出**：需求理解摘要

---

### ✅ 阶段 2: 代码库探索
- [ ] 首要：查找并阅读 CLAUDE.md
- [ ] 并行启动 2-3 个 code-explorer agents
  - Agent 1: 探索实体和数据模型
  - Agent 2: 探索服务层和业务逻辑
  - Agent 3: 探索 API 层和控制器
- [ ] 可选：使用 context7 查询依赖库文档
- [ ] 汇总探索结果
- [ ] 列出必读文件清单

**产出**：代码库探索报告

---

### ✅ 阶段 3: 澄清问题
- [ ] 识别模糊或不明确的需求
- [ ] 识别多个有效实施方案
- [ ] 使用 AskUserQuestion 工具提问
- [ ] 记录用户反馈
- [ ] 更新需求理解

**产出**：澄清结果或"无需澄清"

---

### ✅ 阶段 4: 架构设计
- [ ] **必须**：使用 ultrathink（sequential-thinking）进行深度架构分析
  - 分析需求组件
  - 设计数据结构（遵循 CLAUDE.md）
  - 设计 API 端点（遵循 CLAUDE.md）
  - 设计服务层架构
  - 识别风险和边缘情况
  - 规划实施步骤
- [ ] 可选：启动 code-architect agent
- [ ] 可选：搜索架构模式（exa/WebSearch）
- [ ] **必须**：等待用户确认架构方案

**产出**：完整架构设计和实施计划

---

### ✅ 阶段 5: 实施
- [ ] 确认用户已批准架构
- [ ] 按计划顺序实施：
  1. 数据层（实体、数据库）
  2. 数据访问层（Repository）
  3. 服务层（业务逻辑）
  4. DTO（请求/响应结构）
  5. API 层（控制器/路由）
  6. 验证和错误处理
- [ ] 严格遵循 CLAUDE.md 规范
- [ ] 每个模块完成后及时测试
- [ ] 可选：使用 context7 查询 API 文档

**产出**：完整的功能实现代码

---

### ✅ 阶段 6: 质量审查
- [ ] 并行启动 3 个 code-reviewer agents
  - Reviewer 1: Bug 和逻辑错误
  - Reviewer 2: 代码风格和质量
  - Reviewer 3: 项目规范遵循
- [ ] 汇总审查结果
- [ ] 修复高置信度 bug（≥80%）
- [ ] 修复严重质量和规范问题
- [ ] 记录暂不处理的问题
- [ ] 完成安全检查清单

**产出**：审查报告和修复记录

---

### ✅ 阶段 7: 总结
- [ ] 编写变更摘要
- [ ] 列出修改文件清单
- [ ] 列出新增 API
- [ ] 记录数据库变更
- [ ] 提供后续建议：
  - 测试计划
  - 部署注意事项
  - CHANGELOG 条目
  - OpenAPI 文档生成
  - 可选功能扩展
- [ ] 记录 MCP 工具使用情况

**产出**：完整总结文档

---

## MCP 工具速查

### context7 - 库文档查询
- **用途**：获取最新库文档和 API 参考
- **阶段**：2、4、5
- **降级**：WebSearch + Grep + Read

### exa - 网页搜索和代码示例
- **用途**：搜索高质量内容和代码示例
- **阶段**：1、4、6
- **降级**：WebSearch

### sequential-thinking - 深度分析
- **用途**：复杂问题的深度思考和推理
- **阶段**：1（可选）、4（必须）
- **降级**：EnterPlanMode 或思维链分析

---

## Agents 速查

### code-explorer
- **用途**：深度分析代码库，追踪执行路径
- **使用阶段**：2
- **并行数量**：2-3 个
- **配置**：model 从 `agents/code-explorer.md` YAML 读取

### code-architect
- **用途**：设计架构蓝图，制定实施方案
- **使用阶段**：4
- **并行数量**：2-3 个（可选）
- **配置**：model 从 `agents/code-architect.md` YAML 读取

### code-reviewer
- **用途**：代码审查，识别 bug 和规范问题
- **使用阶段**：6
- **并行数量**：3 个
- **配置**：model 从 `agents/code-reviewer.md` YAML 读取

---

## 何时使用 ultrathink

### ✅ 应该使用
- 需求涉及多个模块或系统集成
- 需求包含复杂业务逻辑或工作流
- 需求描述模糊或不完整
- 需求之间存在依赖关系或冲突
- **架构设计阶段（阶段 4）- 必须使用**

### ❌ 不需要使用
- 单一、明确的需求
- 简单的 CRUD 操作
- 直接的代码修改
- 需求已经非常清晰且范围明确

---

## 降级决策流程

```
尝试 MCP 工具
  ↓
成功？
  ├─ 是 → 继续使用
  └─ 否 → 立即切换降级方案 → 继续工作流（不中断）
```

**重要**：永远不要因为 MCP 工具不可用而中断工作流。

---

## 常见实施顺序

### 通用实施顺序（适用于大多数后端功能）
1. 数据层：实体定义、数据库模式
2. 数据访问层：Repository/DAO
3. 服务层：业务逻辑、事务管理
4. 传输对象：DTO/请求响应结构
5. API 层：控制器/路由处理
6. 验证：输入验证、错误处理
7. 测试：单元测试、集成测试

### 前端功能实施顺序
1. 数据模型：类型定义、接口
2. API 客户端：HTTP 请求封装
3. 状态管理：Store/Context
4. UI 组件：可复用组件
5. 页面组件：完整页面
6. 路由：路由配置
7. 测试：组件测试、E2E 测试

### 全栈功能实施顺序
1. 数据库设计
2. 后端 API 实现
3. API 文档和测试
4. 前端数据模型
5. 前端 UI 实现
6. 集成测试
7. 端到端测试

---

## 安全检查清单

### 输入验证
- [ ] 所有用户输入都经过验证
- [ ] 验证数据类型、长度、格式
- [ ] 验证文件上传类型和大小
- [ ] 验证 ID 和数值范围

### 认证和授权
- [ ] 需要认证的端点添加了认证中间件
- [ ] 正确验证了用户权限
- [ ] 用户只能访问自己的资源

### 注入防护
- [ ] 使用参数化查询防止 SQL 注入
- [ ] 验证和转义用户输入防止 XSS
- [ ] 防止命令注入

### 敏感信息
- [ ] 不在日志中记录密码、token
- [ ] 不在响应中返回敏感字段
- [ ] 使用环境变量存储敏感配置
- [ ] 对敏感数据加密存储

### 错误处理
- [ ] 不在错误消息中暴露内部实现细节
- [ ] 统一的错误响应格式
- [ ] 使用正确的 HTTP 状态码

---

## 性能优化检查

### 数据库
- [ ] 为常用查询字段添加索引
- [ ] 避免 N+1 查询问题
- [ ] 使用预加载/联合查询
- [ ] 使用分页限制返回数据量
- [ ] 只查询需要的字段

### API
- [ ] 实施请求速率限制
- [ ] 使用缓存减少重复计算
- [ ] 压缩响应数据
- [ ] 使用 CDN 分发静态资源

### 前端
- [ ] 代码分割和懒加载
- [ ] 图片优化和懒加载
- [ ] 使用虚拟滚动处理大列表
- [ ] 防抖和节流用户输入

---

## 常用命令参考

### 测试命令（示例）
```bash
# 运行所有测试
npm test / go test ./... / pytest

# 运行特定测试
npm test -- <file> / go test -run <test> / pytest <file>

# 测试覆盖率
npm run coverage / go test -cover / pytest --cov
```

---

## 重要原则

1. **全程使用中文**与用户沟通
2. **严格遵循 CLAUDE.md**项目规范
3. **主动提问**澄清不明确的地方
4. **善用 ultrathink**处理复杂问题
5. **并行执行**agents 提高效率
6. **等待确认**架构设计后再实施
7. **质量把关**实施后必须审查
8. **不中断工作流**MCP 工具不可用时使用降级方案

---

## 详细文档

- **MCP 工具详细说明**：[mcp-tools.md](mcp-tools.md)
- **各阶段详细指南**：[phase-1-discovery.md](phase-1-discovery.md) ~ [phase-7-summary.md](phase-7-summary.md)
- **故障排查**：[troubleshooting.md](troubleshooting.md)
- **输出模板**：[output-template.md](../assets/output-template.md)
