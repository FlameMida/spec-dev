# 故障排查指南

本文档提供常见问题的排查和解决方案。

---

## MCP 工具问题

### MCP 工具调用失败

**症状**：MCP 工具（context7、exa、sequential-thinking）调用返回错误

**排查步骤**：
1. 确认 MCP 服务器是否正在运行
2. 检查 MCP 配置文件是否正确
3. 查看 MCP 服务器日志

**解决方案**：
- **立即切换到降级方案**，不要中断工作流
- 记录失败情况，继续使用降级工具完成任务
- 在总结阶段报告 MCP 工具问题

**降级方案参考**：
- context7 → WebSearch + Grep + Read
- exa → WebSearch
- sequential-thinking → EnterPlanMode 或思维链分析

### MCP 工具返回不相关内容

**症状**：查询结果与需求不匹配

**原因**：查询关键词不够精确

**解决方案**：
1. 优化查询关键词，增加上下文
2. 尝试不同的查询方式
3. 如果多次失败，切换到降级方案

**示例**：
```bash
# 不够精确
context7.get-library-docs: "gin"

# 更精确
context7.get-library-docs: "/gin-gonic/gin" mode="code" topic="middleware authentication"
```

---

## Agent 执行问题

### Agent 找不到文件

**症状**：Agent 报告找不到指定的文件或目录

**排查步骤**：
1. 确认文件路径是否正确
2. 检查当前工作目录
3. 验证文件是否存在

**解决方案**：
```bash
# 检查文件是否存在
ls -la /path/to/file

# 检查当前工作目录
pwd

# 使用绝对路径而不是相对路径
```

### Agent 超时

**症状**：Agent 执行时间过长或超时

**原因**：
- 搜索范围太大
- 代码库太大
- 任务过于复杂

**解决方案**：
1. 缩小搜索范围（使用更精确的 glob pattern）
2. 拆分任务，分多个 agents 并行执行
3. 增加超时时间（如果合理）

### Agent 结果不符合预期

**症状**：Agent 返回的分析结果不准确或不完整

**解决方案**：
1. 检查传递给 agent 的 prompt 是否清晰
2. 提供更多上下文信息
3. 亲自验证 agent 的发现
4. 必要时手动补充分析

---

## CLAUDE.md 相关问题

### CLAUDE.md 文件缺失

**症状**：项目根目录没有 CLAUDE.md 文件

**影响**：无法了解项目规范和约定

**解决方案**：
1. 通过代码探索推断项目规范：
   - 查看现有代码的组织结构
   - 识别命名约定
   - 识别设计模式
   - 查找配置文件（.editorconfig、.eslintrc 等）

2. 记录推断的规范

3. 在总结阶段建议创建 CLAUDE.md

### CLAUDE.md 规范不明确

**症状**：CLAUDE.md 存在但描述模糊

**解决方案**：
1. 查看实际代码验证规范
2. 在阶段 3 向用户澄清不明确的规范
3. 以实际代码为准
4. 在总结阶段建议完善 CLAUDE.md

### CLAUDE.md 规范与最佳实践冲突

**症状**：项目规范与行业最佳实践不一致

**解决方案**：
1. **优先遵循 CLAUDE.md**（项目一致性更重要）
2. 如果规范确实有问题，在总结阶段：
   - 说明冲突情况
   - 解释为什么最佳实践更优
   - 建议更新 CLAUDE.md

---

## 代码实施问题

### 依赖库版本冲突

**症状**：导入的库与项目现有版本不兼容

**解决方案**：
1. 检查项目的依赖文件（package.json、项目依赖配置文件（如 package.json, requirements.txt, go.mod, pom.xml） 等）
2. 使用项目中已安装的版本
3. 如需升级，与用户确认

### 找不到合适的实现模式

**症状**：不确定如何实现某个功能

**解决方案**：
1. 使用 context7 或 WebSearch 查询官方文档
2. 使用 Grep 搜索项目中的类似实现
3. 使用 exa 搜索代码示例
4. 向用户询问偏好的实现方式

### 实施中发现需求理解有误

**症状**：代码写到一半发现与需求不符

**解决方案**：
1. **立即停止实施**
2. 与用户澄清理解
3. 如有必要，回到阶段 3 或 4
4. 更新设计后重新实施

---

## 质量审查问题

### Reviewers 意见相互矛盾

**症状**：不同 reviewers 对同一段代码有不同的评价

**解决方案**：
1. 亲自审查相关代码
2. 以实际代码和项目规范为准
3. 考虑每个 reviewer 的审查焦点（bug vs 质量 vs 规范）
4. 使用判断力权衡不同意见

### 发现问题太多，无法全部修复

**症状**：审查发现数十个问题，修复时间过长

**解决方案**：
1. 按优先级分类：
   - 必须修复：高置信度 bug、安全问题、严重规范违反
   - 应该修复：中置信度 bug、严重质量问题
   - 可选修复：一般质量问题、轻微规范问题

2. 聚焦于必须修复的问题

3. 记录其他问题供后续改进

4. 与用户沟通，确认优先级

### Reviewer 报告 false positive

**症状**：Reviewer 报告的问题实际上不存在

**解决方案**：
1. 亲自验证问题
2. 如果确认是 false positive，标记并忽略
3. 记录在总结阶段，帮助改进 reviewer prompts

---

## 性能问题

### 工作流执行太慢

**症状**：整个 7 阶段流程耗时过长

**原因分析**：
- 代码库太大
- 并行 agents 太多或太少
- 搜索范围太广
- MCP 工具响应慢

**优化方案**：
1. **缩小搜索范围**：
   - 使用更精确的 glob patterns
   - 聚焦于最相关的目录

2. **优化并行策略**：
   - 阶段 2：2-3 个 code-explorer agents
   - 阶段 6：3 个 code-reviewer agents
   - 不要启动过多 agents

3. **使用降级方案**：
   - 如果 MCP 工具慢，直接用降级方案

4. **跳过可选步骤**：
   - code-architect agent 是可选的
   - 简单需求不使用 ultrathink

### 数据库查询性能差

**症状**：实施的代码存在性能问题

**常见原因**：
- N+1 查询问题
- 缺少索引
- 查询返回过多数据
- 没有使用分页


---

## 架构设计问题

### ultrathink 分析不够深入

**症状**：sequential-thinking 的分析结果过于简单

**解决方案**：
1. 增加 totalThoughts 数量
2. 在每个 thought 中提供更多上下文
3. 明确要求分析的方面（数据结构、API、服务层等）
4. 如果降级，使用 EnterPlanMode 进行更详细的规划

### 架构设计与现有代码冲突

**症状**：设计的架构与项目现有模式不一致

**解决方案**：
1. 重新审查现有代码模式
2. 调整设计以保持一致性
3. 如果确实需要新模式，与用户确认
4. 在总结阶段说明架构变更原因

---

## 用户沟通问题

### 用户未回应澄清问题

**症状**：使用 AskUserQuestion 后用户没有回应

**解决方案**：
1. 等待用户回应（不要继续）
2. 不要猜测或假设答案
3. 如果问题不是必须的，可以采用保守方案并说明原因

### 用户反复修改需求

**症状**：用户在实施过程中多次修改需求

**解决方案**：
1. 保持耐心，这是正常的
2. 每次变更后更新需求理解
3. 如果变更较大，建议重新设计架构
4. 在总结阶段记录需求变更历史

---

## 一般建议

### 遇到未知问题

1. **不要慌张**：系统性地分析问题
2. **查阅文档**：使用 context7/WebSearch
3. **参考现有代码**：使用 Grep/Read
4. **寻求帮助**：向用户提问
5. **记录问题**：在总结阶段报告

### 工作流卡住

如果在某个阶段卡住：

1. **回顾前一阶段**：确认前置条件是否满足
2. **简化问题**：拆分为更小的步骤
3. **尝试不同方法**：MCP 工具、降级方案、手动分析
4. **与用户沟通**：说明遇到的困难，寻求指导

### 保持工作流完整性

**核心原则**：不要因为工具问题而中断工作流

- MCP 工具失败 → 使用降级方案
- Agent 失败 → 手动执行相应任务
- 信息不足 → 向用户提问

**目标**：无论遇到什么问题，都要完成 7 个阶段，交付完整的功能。
