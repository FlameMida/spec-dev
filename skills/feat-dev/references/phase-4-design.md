# 阶段 4: 架构设计

## 🎯 目标

设计详细的实施方案,包括数据库设计、API 端点设计、服务层架构和详细的实施步骤。

---

## 阶段标记

**开始时输出**:
```markdown
---
## 🚀 当前阶段:4 - 架构设计
---
```

**结束时输出**(用户确认后):
```markdown
---
✅ 阶段 4 完成

📍 下一阶段:5 - 实施
---
```

---

## MCP 工具使用

### 📚 优先尝试:context7.query-docs
**目的**:获取框架的架构指南
**降级方案**:WebSearch

### 🔍 优先尝试:exa.web_search_exa
**目的**:搜索架构模式和设计最佳实践
**降级方案**:WebSearch

---

## 必须使用: code-architect Agent

**Phase 4 核心步骤**: 根据需求复杂度选择合适的架构设计模式。

---

## ⚠️ 复杂度判断和模式选择

### 判断需求复杂度

#### 简单/中等需求（使用单方案模式）
- 单一功能或涉及 2-3 个模块
- 实现路径清晰明确
- 不涉及重大架构变更

#### 复杂需求（使用多方案模式）
满足以下**任一**条件：
- ✅ 有**多种明显不同的实现路径**
- ✅ 存在**重大架构权衡**
- ✅ **影响多个核心模块**（3个以上）
- ✅ **引入新的技术或架构模式**
- ✅ **用户明确要求**对比多个方案

---

## 结构化上下文模板

**重要**：此模板在模式 1 和模式 2 中都会用到。

```markdown
## 完整上下文

### 1. 需求理解 (阶段 1 结果)

#### 核心功能
${将阶段 1 识别的核心功能完整列出}

#### 业务实体
${将阶段 1 识别的业务实体和字段需求完整列出}

#### API 端点需求
${将阶段 1 识别的 API 端点需求完整列出}

#### 业务规则
${将阶段 1 识别的业务规则和约束完整列出}

#### 集成点
${将阶段 1 识别的集成点和依赖完整列出}

---

### 2. 代码库探索发现 (阶段 2 结果)

#### CLAUDE.md 规范要点
${如果有 CLAUDE.md,列出关键规范}

#### 项目架构和技术栈
- 架构风格: [MVC/分层架构/微服务/单体等]
- 编程语言: [使用的语言和版本]
- 主要框架: [Web框架、ORM等]
- 数据库: [数据库类型和版本]
- 关键依赖: [重要的第三方库]

#### 相关现有实现
${列出 code-explorer 发现的相关组件}

#### 设计模式和代码风格
${列出项目中使用的设计模式和约定}

#### 必读架构参考文件
${列出 code-explorer 识别的 5-10 个关键文件路径}

---

### 3. 用户澄清和决策 (阶段 3 结果)

${如果阶段 3 使用了 AskUserQuestion,列出所有问题和用户的回答}

#### 澄清的问题 1
**问题**: [原始问题]
**用户回答**: [用户的选择和说明]
**影响**: [这个决策如何影响架构设计]

${如果没有澄清问题,说明: 无需澄清 - 需求已经明确}

---

### 4. 外部资源研究 (如适用)

${如果阶段 2.5 进行了外部资源研究,列出关键发现}
```

---

## 模式 1: 单方案设计（简单/中等需求）

### 执行步骤

**步骤 1: 主进程使用 ultrathink 进行深度分析**

调用 **mcp__sequential-thinking__sequentialthinking 工具**：

```markdown
使用 sequential-thinking 工具分析：
1. 分解需求组件和依赖关系
2. 分析可能的实现路径
3. 做出关键架构决策（基于项目约定和最佳实践）
4. 识别主要风险和权衡点
5. 确定推荐的架构方向
```

**步骤 2: 启动单个 code-architect agent 细化设计**

使用上面的**结构化上下文模板**传递信息，添加 ultrathink 分析结果：

```markdown
Task: 细化架构设计
- description: "基于 ultrathink 分析细化架构设计"
- prompt: "## 任务
基于以下 ultrathink 深度分析结果，细化架构设计并产出详细的实施蓝图

## Ultrathink 分析结果
${将 sequential-thinking 的分析结果完整列出}

---

[使用上面的结构化上下文模板]

## 细化设计要求

基于 ultrathink 的分析和完整上下文,请细化架构设计：

1. **探索代码库** - 深入探索相关代码
2. **数据库设计** - 实体定义、关联、索引，符合 CLAUDE.md 规范
3. **API 端点设计** - REST 端点、请求/响应，符合 CLAUDE.md 规范
4. **服务层架构** - 服务接口、业务逻辑、依赖注入，符合 CLAUDE.md 规范
5. **风险分析** - 验证 ultrathink 识别的风险
6. **详细实施步骤** - 至少 5-10 个详细步骤
7. **关键架构参考文件** - 返回 5-10 个必读文件"

- subagent_type: "spec-dev:code-architect"
- model: "sonnet"
- run_in_background: false
```

**步骤 3: 向用户展示方案**

展示单一的最佳方案，包含：
- Ultrathink 的深度分析结果
- Code-architect 的详细设计
- 完整的实施步骤

---

## 模式 2: 多方案设计（复杂需求）

### 执行步骤

**步骤 1: 并行启动 2-3 个 code-architect agents**

⚠️ **不使用主进程 ultrathink**（agents 会各自进行深度分析）

⚠️ **并行执行要求**：
- **必须在单个消息中**发起 2-3 个 Task 工具调用
- **每个 Task 必须设置** `run_in_background: true`
- **然后使用 TaskOutput** 收集每个 agent 的结果

**Agent 方案分工**：
- Agent 1: 最小改动方案 - 快速交付，最小化风险
- Agent 2: 清晰架构方案 - 追求最佳实践和长期可维护性
- Agent 3: 实用平衡方案 - 在速度和质量之间找平衡（通常推荐）

**并行调用模板**：

每个 agent 使用上面的**结构化上下文模板**传递信息：

```markdown
Task 1/2/3: 设计[方案类型]架构方案
- description: "设计[最小改动/清晰架构/实用平衡]方案"
- prompt: "## 任务
为 [功能名称] 设计详细的架构蓝图

⚠️ 要求：
1. 进行系统化的深度分析和架构设计
2. 设计方案类型: **[最小改动/清晰架构/实用平衡]方案**
3. 提供详细的架构决策理由和权衡分析

---

[使用上面的结构化上下文模板]

## 设计要求

基于完整上下文,设计[最小改动/清晰架构/实用平衡]方案：

1. **探索代码库** - 深入探索相关代码
2. **数据库设计** - 实体定义、关联、索引，符合 CLAUDE.md 规范
3. **API 端点设计** - REST 端点、请求/响应，符合 CLAUDE.md 规范
4. **服务层架构** - 服务接口、业务逻辑、依赖注入，符合 CLAUDE.md 规范
5. **风险分析** - 识别技术实现层面的风险
6. **详细实施步骤** - 至少 5-10 个详细步骤
7. **关键架构参考文件** - 返回 5-10 个必读文件"

- subagent_type: "spec-dev:code-architect"
- model: "sonnet"
- run_in_background: true
```

**步骤 2: 读取所有 agents 推荐的架构文件**

主进程必须亲自阅读这些架构参考文件，建立深度理解。

**步骤 3: 整合所有方案**

对比 2-3 个方案的优劣势：
- 开发时间
- 代码质量
- 可维护性
- 风险评估

进行权衡分析，给出推荐意见及理由。

**步骤 4: 向用户展示多方案对比**

展示内容：
- 方案对比表格
- 每个方案的详细设计
- 权衡分析
- 推荐意见及理由

询问用户选择哪个方案。

---

## 🎯 架构方案设计

### 数据库设计

**实体定义**：
- 表结构、字段类型、约束
- 主键、外键、索引
- 符合 CLAUDE.md 数据库设计规范

### API 端点设计

**REST 端点**：
- HTTP 方法、路径设计
- 请求/响应结构
- 认证和授权要求
- 符合 CLAUDE.md API 设计规范

### 服务层架构

**服务设计**：
- 服务接口定义
- 业务逻辑流程
- 依赖关系和注入
- 事务管理策略
- 符合 CLAUDE.md 架构模式

---

## Agent 输出要求

### 必须包含

1. **数据库设计**
   - 实体定义（字段、类型、约束）
   - 表关联关系
   - 索引设计

2. **API 端点设计**
   - 完整的端点列表（方法、路径）
   - 请求/响应示例
   - 认证要求说明

3. **服务层设计**
   - 服务接口定义
   - 业务逻辑流程
   - 依赖关系说明

4. **实施步骤**
   - 至少 5-10 个详细步骤
   - 每步包含: 任务、产出、验证方式
   - 按依赖关系排序

5. **关键架构参考文件**
   - 返回 5-10 个必读文件路径
   - 供主进程阅读理解项目架构

---

## 设计产出

### 模式 1 产出（简单/中等需求）

- 主进程 ultrathink 的深度分析结果
- 单个 code-architect agent 的详细架构设计
- 读取的架构相关文件理解
- 数据库设计（实体/表结构、字段、关联、索引）
- API 端点设计（方法、路径、请求/响应、认证）
- 服务层设计（服务接口、依赖关系、业务逻辑流程）
- **详细实施步骤**（编号列表，每步明确任务和产出）
- 设计理由和说明
- 用户确认

### 模式 2 产出（复杂需求）

- 2-3 个 code-architect agents 的深度架构设计和建议
- 读取的架构相关文件理解
- **多方案对比和权衡分析**（对比表格 + 优劣势分析）
- [针对每个方案] 数据库设计（实体/表结构、字段、关联、索引）
- [针对每个方案] API 端点设计（方法、路径、请求/响应、认证）
- [针对每个方案] 服务层设计（服务接口、依赖关系、业务逻辑流程）
- [针对每个方案] **详细实施步骤**（编号列表，每步明确任务和产出）
- **推荐意见及理由**（基于权衡分析）
- 用户选择确认

---

## 实施步骤

**模式 1: 单方案设计**

1. 主进程使用 ultrathink 深度分析
2. 启动 code-architect agent 细化设计
3. 读取架构参考文件
4. 向用户展示方案并请求确认

**模式 2: 多方案设计**

1. 并行启动 2-3 个 code-architect agents
2. 读取所有 agents 的架构参考文件
3. 整合所有方案，对比优劣势
4. 向用户展示多方案对比
5. 询问用户选择方案

---

## ⚠️ 等待用户确认(CRITICAL CHECKPOINT)

**这是最关键的检查点** - 必须等待用户明确确认架构方案后才能开始实施。

### 向用户展示设计后

使用 **AskUserQuestion** 询问用户（对于模式 2）：

```markdown
询问用户："你希望使用哪个方案？"
选项：
- 方案 1: [最小改动/清晰架构/实用平衡]
- 方案 2: [其他方案]
- 方案 3: [其他方案]
```

### 用户确认后

**必须**确认用户已明确选择方案，然后才能标记阶段 4 为完成。

---

## ✅ 准备好实施了吗?

在用户确认架构方案后：

```markdown
---
✅ 阶段 4 完成

📍 下一阶段:5 - 实施
---
```

**禁止**：
- ❌❌❌ **CRITICAL**：在未获得用户确认时标记阶段 4 为完成
- ❌❌❌ **CRITICAL**：跳过阶段 4 直接进入阶段 5（实施）
- ❌❌❌ **CRITICAL**：用户未确认方案时开始编码

---

## 进入下一阶段

完成架构设计并得到用户确认后，进入 **阶段 5: 实施**。

参见：[phase-5-implement.md](phase-5-implement.md)
