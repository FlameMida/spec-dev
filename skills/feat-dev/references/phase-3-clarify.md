# 阶段 3: 澄清问题

## 目标

填补需求空白，解决模糊和歧义，确保实施方向正确。

---

## 何时提问

在以下情况下**必须**使用 **AskUserQuestion 工具**向用户提问：

### ✅ 必须澄清的情况

1. **模糊或规格不足的需求**
   - 需求描述不够具体
   - 缺少关键业务规则
   - 边缘情况处理不明确

2. **多个有效实施方法**
   - 有多种技术方案可选
   - 不同方案有不同的权衡
   - 用户偏好会影响选择

3. **业务规则细节**
   - 验证规则的具体要求
   - 权限控制的粒度
   - 数据处理的特殊逻辑

4. **与现有功能的关系**
   - 是否应该复用现有组件
   - 是否需要保持向后兼容
   - 是否应该重构现有代码

5. **技术选型或架构决策**
   - 认证方式选择（JWT vs Session）
   - 存储方式选择（Redis vs 数据库）
   - 通信方式选择（WebSocket vs SSE）

### ❌ 不需要澄清的情况

- 需求已经非常明确
- 有明显的最佳实践可遵循
- CLAUDE.md 或项目规范已经规定
- 可以从现有代码推断出模式

---

## 使用 AskUserQuestion 工具

### 工具用法

```
AskUserQuestion:
  questions: [
    {
      question: "完整的问题？",
      header: "简短标签（≤12字符）",
      options: [
        {
          label: "选项 1",
          description: "选项 1 的说明和影响"
        },
        {
          label: "选项 2",
          description: "选项 2 的说明和影响"
        }
      ],
      multiSelect: false  // true 表示可多选
    }
  ]
```

### 最佳实践

#### 1. 一次提问多个问题

一次提出多个问题，尽可能详细的了解整个需求。

#### 2. 提供具体的选项

给出 2-4 个具体选项，而不是开放式问题，根据具体问题的复杂度可以适当增加选项。

#### 3. 说明每个选项的影响

让用户了解选择的后果和权衡。

#### 4. 推荐首选方案

如果有推荐的选项，放在第一位并标注 "(推荐)"。

---

## 典型场景示例

### 场景 1: 认证方式选择

**问题**：用户认证应该使用哪种方式？

**选项**：
- JWT Token (推荐)：无状态，适合分布式系统
- Session：传统方式，需要服务器端会话存储，适合单体应用

### 场景 2: 数据同步策略

**问题**：用户数据更新后，如何同步到前端？

**选项**：
- 轮询 (推荐)：实现简单，适合更新不频繁的场景
- WebSocket：实时双向通信，即时更新，需要维护长连接
- Server-Sent Events：服务器主动推送，比 WebSocket 简单

### 场景 3: 权限控制粒度

**问题**：权限控制应该到什么粒度？

**选项**：
- 角色级别 (推荐)：基于用户角色控制，实现简单
- 资源级别：针对每个资源单独授权，更灵活但复杂
- 字段级别：控制到具体字段，最细粒度但成本高

---

## 处理用户反馈

### 1. 记录用户选择

将用户的回答记录在笔记中，供后续阶段参考。

### 2. 更新需求理解

基于用户反馈，更新阶段 1 的需求理解。

### 3. 补充到架构设计

将澄清的细节纳入阶段 4 的架构设计。

### 4. 继续工作流

**重要**：收到用户反馈后，必须明确继续当前 skill 的工作流：

```markdown
---
📥 已收到用户反馈

🔄 继续阶段 3 - 澄清问题
---

### 用户反馈
- **[主题 1]**：[用户的选择/回答]
- **[主题 2]**：[用户的选择/回答]

已更新需求理解。

---
✅ 阶段 3 完成

📍 下一阶段：4 - 架构设计
---
```

**禁止**：
- ❌❌❌ **CRITICAL**：收到用户反馈后直接跳到阶段 5（实施）
- ❌❌❌ **CRITICAL**：跳过阶段 4（架构设计）
- ❌❌❌ **CRITICAL**：在未完成阶段 3 时进入下一阶段
- ❌❌❌ **CRITICAL**：收到用户反馈后跳出当前 skill

**⚠️ MANDATORY CHECKPOINT（强制检查点）**：
```markdown
如果在阶段 3 使用了 AskUserQuestion：

1. MUST 停止并等待用户回应
2. 收到回应后 MUST 输出：
   ---
   📥 已收到用户反馈

   ⚠️ WORKFLOW CHECKPOINT: 继续阶段 3 - 澄清问题
   （禁止跳出当前 skill，禁止跳过阶段 4）
   ---

3. MUST 处理用户反馈并更新需求理解
4. MUST 完成阶段 3 并输出完成标记（见下方）
5. 然后才能进入阶段 4
```

---

## 输出示例

### 有需要澄清的情况

```markdown
## ❓ 阶段 3: 澄清问题

我发现以下几点需要确认：

1. **认证方式**：用户登录应该使用哪种认证方式？
2. **数据同步**：数据更新后如何同步到前端？
3. **权限控制**：权限控制应该到什么粒度？

[使用 AskUserQuestion 工具提问]

---

### 用户反馈

- **认证方式**：JWT Token
- **数据同步**：轮询（每 30 秒）
- **权限控制**：角色级别

已更新需求理解和架构设计计划。
```

### 无需澄清的情况

```markdown
## ❓ 阶段 3: 澄清问题

经过分析，需求描述清晰，项目规范完善，无需额外澄清。

可以直接进入架构设计阶段。
```

---

## 进入下一阶段

完成问题澄清后，进入 **阶段 4: 架构设计**。

参见：[phase-4-design.md](phase-4-design.md)
